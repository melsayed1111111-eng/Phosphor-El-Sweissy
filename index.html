<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø³Ù…Ø§Ùƒ Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„Ø³ÙˆÙŠØ³ÙŠ | Ù…Ù„Ùƒ Ø§Ù„ÙØ³ÙÙˆØ±</title>

    <!-- Favicon (Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ§Ø¨Ø©) -->
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2970/2970104.png" type="image/png">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700&family=El+Messiri:wght@700&family=Pacifico&display=swap"
        rel="stylesheet">

    <!-- Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-blue: #003366;
            /* Ø£Ø²Ø±Ù‚ Ø¨Ø­Ø±ÙŠ Ø¹Ù…ÙŠÙ‚ */
            --accent-cyan: #00bcd4;
            /* Ù„ÙˆÙ† Ø§Ù„Ø¨Ø­Ø± Ø§Ù„ÙØ§ØªØ­ */
            --glass-white: rgba(255, 255, 255, 0.85);
            --nature-border: 12px solid var(--primary-blue);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }

        body {
            background: url('https://images.unsplash.com/photo-1551244072-5d12893278ab?q=80&w=1920') no-repeat center center fixed;
            background-size: cover;
            color: #1a1a1a;
            overflow-x: hidden;
            border-left: var(--nature-border);
            border-right: var(--nature-border);
            user-select: none;
            min-height: 100vh;
        }

        .glass-panel {
            background: var(--glass-white);
            backdrop-filter: blur(15px);
            border: 2px solid var(--primary-blue);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        /* Navbar */
        nav {
            position: fixed;
            top: 0;
            width: calc(100% - 24px);
            height: 100px;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 0 5%;
            z-index: 1000;
            margin: 0 12px;
            transition: 0.4s;
        }

        nav.scrolled {
            background: rgba(255, 255, 255, 0.95);
            height: 80px;
            border-bottom: 3px solid var(--accent-cyan);
        }

        .brand-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .brand-name {
            font-family: 'El Messiri', sans-serif;
            font-size: 28px;
            font-weight: 900;
            color: var(--primary-blue);
            line-height: 1;
            text-align: center;
        }

        .fish-icon {
            color: var(--accent-cyan);
            font-size: 24px;
            margin: 0 10px;
        }

        /* Search & Sidebar Triggers */
        .nav-right,
        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .icon-trigger {
            font-size: 22px;
            color: var(--primary-blue);
            cursor: pointer;
            transition: 0.3s;
        }

        .icon-trigger:hover {
            color: var(--accent-cyan);
            transform: scale(1.1);
        }

        /* Sidebar */
        #sidebar {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100%;
            z-index: 5000;
            transition: 0.5s;
            padding: 30px 20px;
            overflow-y: auto;
        }

        #sidebar.open {
            right: 0;
        }

        .side-item {
            padding: 15px;
            border-bottom: 1px dashed var(--accent-cyan);
            cursor: pointer;
            font-weight: bold;
        }

        .sub-menu {
            max-height: 0;
            overflow: hidden;
            transition: 0.4s;
            background: rgba(0, 0, 0, 0.03);
        }

        /* Hero Slider */
        .hero-slider {
            width: 100%;
            height: 70vh;
            position: relative;
            overflow: hidden;
            border-bottom: 8px solid var(--primary-blue);
            margin-top: 100px;
        }

        .slides {
            display: flex;
            height: 100%;
            transition: 1.2s cubic-bezier(0.645, 0.045, 0.355, 1);
        }

        .slide {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .slide-img {
            max-width: 85%;
            max-height: 85%;
            object-fit: contain;
            border: 8px solid white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
            padding: 40px 5%;
        }

        .card {
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: 0.4s;
            border-bottom: 6px solid var(--accent-cyan) !important;
        }

        .card:hover {
            transform: translateY(-10px);
            background: #fff;
        }

        .card img {
            width: 100%;
            height: 220px;
            object-fit: cover;
            border-radius: 12px;
        }

        /* Forms */
        .vertical-form input,
        .vertical-form select,
        .vertical-form textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            display: block;
        }

        .admin-btn {
            padding: 12px 24px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .admin-btn:hover {
            background: var(--accent-cyan);
        }

        /* Float Cart */
        .cart-float {
            position: fixed;
            bottom: 30px;
            left: 40px;
            background: var(--accent-cyan);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            z-index: 1500;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        /* Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 4000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-content {
            max-width: 900px;
            margin: 30px auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            position: relative;
        }

        footer {
            text-align: center;
            padding: 40px;
            background: var(--primary-blue);
            color: white;
        }
    </style>
</head>

<body oncontextmenu="return false;">

    <!-- Sidebar Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
    <div id="sidebar" class="glass-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="color:var(--primary-blue)">Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø³Ù…Ø§Ùƒ ğŸŸ</h3>
            <i class="fa fa-times icon-trigger" onclick="toggleSidebar()"></i>
        </div>
        <div id="side-categories"></div>
    </div>

    <!-- Navbar Ø§Ù„Ù‡ÙŠØ¯Ø± -->
    <nav id="navbar">
        <div class="nav-right">
            <i class="fa fa-search icon-trigger" onclick="toggleSearch()"></i>
            <div id="search-bar" class="glass-panel"
                style="display:none; position:absolute; top:110px; padding:10px; width:250px;">
                <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³Ù…Ùƒ..." oninput="liveSearch()"
                    style="width:100%; padding:8px; border:none; outline:none;">
            </div>
        </div>

        <div class="brand-container" onclick="backToStore()" style="cursor:pointer;">
            <div style="display:flex; align-items:center;">
                <i class="fa fa-fish-bubble fish-icon"></i>
                <h1 class="brand-name">Ø£Ø³Ù…Ø§Ùƒ<br>Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„Ø³ÙˆÙŠØ³ÙŠ</h1>
                <i class="fa fa-fish fish-icon"></i>
            </div>
            <small style="color:var(--accent-cyan); letter-spacing:2px;">Ø·Ø§Ø²Ø¬ Ù…Ù† Ø§Ù„Ø¨Ø­Ø± Ø¥Ù„ÙŠÙƒ</small>
        </div>

        <div class="nav-left">
            <i class="fa fa-bars icon-trigger" onclick="toggleSidebar()"></i>
            <i class="fa fa-user-shield icon-trigger" onclick="loginAdmin()"></i>
        </div>
    </nav>

    <main id="store-front">
        <!-- Slider Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± -->
        <section class="hero-slider">
            <div class="slides" id="heroSlider">
                <!-- Ø§Ù„ØµÙˆØ± Ø³ØªØ¬Ù„Ø¨ Ù…Ù† Ø§Ù„ÙÙŠØ±Ø¨ÙŠØ² Ø£Ùˆ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¨Ø§Ù„Ø£Ø³ÙÙ„ -->
            </div>
        </section>

        <!-- Features -->
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; padding: 40px 5%; text-align: center;">
            <div class="glass-panel" style="padding: 20px; cursor: pointer;" onclick="contactSupport()">
                <i class="fa fa-headset" style="font-size: 30px; color: var(--accent-cyan);"></i>
                <h4>Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† ÙˆØ§ØªØ³Ø§Ø¨</h4>
            </div>
            <div class="glass-panel" style="padding: 20px; cursor: pointer;" onclick="showShippingInfo()">
                <i class="fa fa-truck-fast" style="font-size: 30px; color: var(--accent-cyan);"></i>
                <h4>ØªÙˆØµÙŠÙ„ Ù…Ù†Ø²Ù„ÙŠ Ø³Ø±ÙŠØ¹</h4>
            </div>
        </div>

        <h2 style="text-align:center; color:var(--primary-blue);">Ø´Ø±ÙˆØ© Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ø© ğŸ¦</h2>
        <section class="grid" id="customer-product-grid"></section>

        <h2 style="text-align:center; color:var(--primary-blue);">ÙÙˆØ§Ø¦Ø¯ Ø§Ù„Ø£Ø³Ù…Ø§Ùƒ ğŸŒŠ</h2>
        <section class="grid" id="customer-blog-grid"></section>

        <!-- Reviews -->
        <section style="padding: 40px 5%; text-align: center;">
            <h2 style="color:var(--primary-blue)">Ø¢Ø±Ø§Ø¡ Ø¹Ø´Ø§Ù‚ Ø§Ù„ÙØ³ÙÙˆØ±</h2>
            <div id="reviews-display"></div>
            <div class="glass-panel vertical-form" style="padding:25px; max-width:600px; margin:20px auto;">
                <input type="text" id="rev-name" placeholder="Ø§Ù„Ø§Ø³Ù…">
                <textarea id="rev-text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø£ÙŠÙƒ Ù‡Ù†Ø§ ÙˆØ§Ø¶ØºØ· Enter" rows="2"></textarea>
            </div>
        </section>

        <footer>
            Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; 2026 | Ø£Ø³Ù…Ø§Ùƒ Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„Ø³ÙˆÙŠØ³ÙŠ <br>
            ØªØµÙ…ÙŠÙ… ÙˆØªØ·ÙˆÙŠØ±: <span style="font-weight:bold; color:var(--accent-cyan);">Mohamed Salah Elsayed</span>
        </footer>
    </main>

    <!-- Admin Panel Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
    <div id="admin-panel" style="display:none; padding:120px 5% 50px; background:#f0faff; min-height:100vh;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px;">
            <h2>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„</h2>
            <button class="admin-btn" style="background:#333;" onclick="backToStore()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 2fr; gap:30px;">
            <div class="glass-panel vertical-form" style="padding:20px; height: fit-content;">
                <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h4>
                <input type="hidden" id="edit-prod-id">
                <input type="text" id="adm-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ù…Ùƒ">
                <textarea id="adm-imgs" placeholder="Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµÙˆØ± (Enter Ù„ÙƒÙ„ Ø±Ø§Ø¨Ø·)" rows="4"></textarea>
                <input type="number" id="adm-price" placeholder="Ø§Ù„Ø³Ø¹Ø± Ù„Ù„ÙƒÙŠÙ„Ùˆ">
                <input type="text" id="adm-cat" placeholder="Ø§Ù„ÙØ¦Ø© (Ù…Ø«Ù„Ø§Ù‹: Ø£Ø³Ù…Ø§ÙƒØŒ Ù‚Ø´Ø±ÙŠØ§Øª)">
                <input type="text" id="adm-subcat" placeholder="Ø§Ù„ÙØ¦Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©">
                <button class="admin-btn" style="width:100%" onclick="handleProductSave()">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>

                <hr style="margin:20px 0;">
                <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©</h4>
                <input type="hidden" id="edit-blog-id">
                <input type="text" id="adm-blog-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø§Ù„">
                <input type="text" id="adm-blog-img" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©">
                <textarea id="adm-blog-desc" placeholder="Ø§Ù„Ù…Ø­ØªÙˆÙ‰"></textarea>
                <button class="admin-btn" style="width:100%; background:#8e44ad" onclick="handleBlogSave()">Ù†Ø´Ø± ÙÙŠ
                    Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©</button>

                <hr style="margin:25px 0;">
                <h4>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h4>
                <input type="text" id="adm-wa" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨">
                <button class="admin-btn" style="width:100%; background:#2980b9" onclick="handleSettingsSave()">Ø­ÙØ¸
                    Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>

                <button class="admin-btn" style="width:100%; background:#2c3e50; margin-top:10px"
                    onclick="exportOrdersToExcel()">
                    <i class="fa fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Excel)
                </button>

                <hr style="margin:25px 0;">
                <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±</h4>
                <textarea id="adm-slider-input" placeholder="Ø±ÙˆØ§Ø¨Ø· ØµÙˆØ± Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± (Ø±Ø§Ø¨Ø· ÙÙŠ ÙƒÙ„ Ø³Ø·Ø±)" rows="4"></textarea>
                <button class="admin-btn" style="width:100%; background:#f39c12" onclick="handleSliderSave()">ØªØ­Ø¯ÙŠØ«
                    Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±</button>

                <button class="admin-btn" style="width:100%; background:#e74c3c; margin-top:20px"
                    onclick="logoutAdmin()">Ø®Ø±ÙˆØ¬ Ù†Ù‡Ø§Ø¦ÙŠ</button>
            </div>

            <div class="data-lists">
                <h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h4>
                <div id="list-products"></div>
                <h4 style="margin-top:30px">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª</h4>
                <div id="list-blogs"></div>
                <h4 style="margin-top:30px">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¢Ø±Ø§Ø¡</h4>
                <div id="admin-reviews-list"></div>
            </div>
        </div>
    </div>

    <!-- Modals (Detail & Checkout) -->
    <div id="detail-overlay" class="modal-overlay">
        <div class="modal-content glass-panel">
            <button onclick="closeModals()"
                style="position:absolute; top:15px; left:15px; border:none; padding:10px; cursor:pointer;"><i
                    class="fa fa-times"></i></button>
            <div id="modal-body"></div>
        </div>
    </div>

    <div id="checkout-overlay" class="modal-overlay">
        <div class="modal-content glass-panel vertical-form" style="max-width:500px;">
            <h3 style="text-align:center;">ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø¨ ğŸ§¾</h3>
            <div id="cart-list" style="margin-bottom:15px;"></div>
            <input type="text" id="c-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
            <input type="tel" id="c-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„">
            <select id="c-gov">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„</option>
                <option value="Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©">Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option>
                <option value="Ø§Ù„Ø¬ÙŠØ²Ø©">Ø§Ù„Ø¬ÙŠØ²Ø©</option>
                <option value="Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©">Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©</option>
                <option value="Ø§Ù„Ø³ÙˆÙŠØ³">Ø§Ù„Ø³ÙˆÙŠØ³</option>
                <option value="Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©">Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©</option>
                <option value="Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯">Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯</option>
            </select>
            <textarea id="c-addr" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ"></textarea>
            <div id="total-price-box"
                style="padding:15px; background:#eef7f2; border-radius:10px; font-weight:bold; margin-bottom:15px;">
            </div>
            <button class="admin-btn" style="background:#25d366; width:100%;" onclick="finalizeOrder()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
                (ÙˆØ§ØªØ³Ø§Ø¨) <i class="fab fa-whatsapp"></i></button>
        </div>
    </div>

    <div class="cart-float" onclick="openCheckout()">
        <i class="fa fa-shopping-basket"></i> (<span id="cart-count">0</span>)
    </div>

    <script>
        // --- 1. Firebase Config (Ø£Ø³Ù…Ø§Ùƒ Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„Ø³ÙˆÙŠØ³ÙŠ) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDcNOtoZynpftdIfLXKatqdo49js45Zcv8",
            authDomain: "my-market-fish.firebaseapp.com",
            projectId: "my-market-fish",
            storageBucket: "my-market-fish.firebasestorage.app",
            messagingSenderId: "885584421730",
            appId: "1:885584421730:web:08720c17c6e753f533423b",
            measurementId: "G-L6CY121JBS"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let allProducts = [], allBlogs = [], cart = [], settings = { wa: "201021422730", ship: 50, govShipping: {} };
        let sliderInterval = null;

        // --- 2. Initialization ---
        window.onload = function () {
            loadAllData();
            if (sessionStorage.getItem('isAdmin') === 'true') showAdmin();
            document.getElementById('rev-text').addEventListener('keypress', e => { if (e.key === 'Enter') sendReview(); });
        };

        function loadAllData() {
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            db.collection("settings").doc("main").onSnapshot(doc => {
                if (doc.exists) settings = { ...settings, ...doc.data() };
            });

            // Ø¬Ù„Ø¨ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±
            db.collection("settings").doc("slider").onSnapshot(doc => {
                const imgs = doc.exists ? doc.data().images : ["https://images.unsplash.com/photo-1519708227418-c8fd9a32b7a2?q=80&w=1200"];
                renderStoreSlider(imgs);
            });

            // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ù…Ø§Ùƒ
            db.collection("products").onSnapshot(snap => {
                const grid = document.getElementById('customer-product-grid');
                const list = document.getElementById('list-products');
                grid.innerHTML = ''; list.innerHTML = ''; allProducts = [];
                snap.forEach(doc => {
                    const p = { id: doc.id, ...doc.data() }; allProducts.push(p);
                    const firstImg = p.images.split(/[\n,]+/)[0];
                    grid.innerHTML += `<div class="card glass-panel" onclick="viewProduct('${p.id}')"><img src="${firstImg}"><h4>${p.name}</h4><b style="color:var(--primary-blue)">${p.price} Ø¬.Ù… / ÙƒÙŠÙ„Ùˆ</b></div>`;
                    list.innerHTML += `<div class="data-item glass-panel" style="padding:10px; margin-bottom:5px; display:flex; justify-content:space-between;"><b>${p.name}</b> <div><button onclick="prepareEditProd('${p.id}')">ØªØ¹Ø¯ÙŠÙ„</button> <button onclick="deleteDoc('products','${p.id}')">Ø­Ø°Ù</button></div></div>`;
                });
                buildSmartSidebar();
            });

            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©
            db.collection("blogs").onSnapshot(snap => {
                const grid = document.getElementById('customer-blog-grid');
                const list = document.getElementById('list-blogs');
                grid.innerHTML = ''; list.innerHTML = ''; allBlogs = [];
                snap.forEach(doc => {
                    const b = { id: doc.id, ...doc.data() }; allBlogs.push(b);
                    grid.innerHTML += `<div class="card glass-panel" onclick="viewBlog('${b.id}')"><img src="${b.img}"><h4>${b.title}</h4></div>`;
                    list.innerHTML += `<div class="data-item glass-panel" style="padding:10px; margin-bottom:5px; display:flex; justify-content:space-between;"><b>${b.title}</b> <div><button onclick="prepareEditBlog('${b.id}')">ØªØ¹Ø¯ÙŠÙ„</button> <button onclick="deleteDoc('blogs','${b.id}')">Ø­Ø°Ù</button></div></div>`;
                });
            });

            // Ø¬Ù„Ø¨ Ø§Ù„Ø¢Ø±Ø§Ø¡
            db.collection("reviews").orderBy("time", "desc").onSnapshot(snap => {
                const display = document.getElementById('reviews-display');
                const adminRev = document.getElementById('admin-reviews-list');
                display.innerHTML = ''; adminRev.innerHTML = '';
                snap.forEach(doc => {
                    const r = doc.data();
                    display.innerHTML += `<div class="glass-panel" style="padding:15px; margin-bottom:10px;"><b>${r.name}:</b> <p>${r.text}</p></div>`;
                    adminRev.innerHTML += `<div class="data-item glass-panel" style="padding:5px;"><span>${r.name}</span> <button onclick="deleteDoc('reviews','${doc.id}')">Ø­Ø°Ù</button></div>`;
                });
            });
        }

        // --- 3. Slider System ---
        function renderStoreSlider(images) {
            const sliderCon = document.getElementById('heroSlider');
            sliderCon.innerHTML = images.map(img => `<div class="slide" style="width:${100 / images.length}%"><img class="slide-img" src="${img}"></div>`).join('');
            sliderCon.style.width = (images.length * 100) + "%";
            if (sliderInterval) clearInterval(sliderInterval);
            let idx = 0;
            sliderInterval = setInterval(() => {
                idx = (idx + 1) % images.length;
                sliderCon.style.transform = `translateX(${idx * (100 / images.length)}%)`;
            }, 5000);
        }

        // --- 4. Product Details & Related ---
        function viewProduct(id) {
            const p = allProducts.find(x => x.id === id);
            const imgs = p.images.split(/[\n,]+/);
            document.getElementById('modal-body').innerHTML = `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:25px;">
                    <div style="overflow:hidden; border-radius:15px; position:relative;">
                        <img id="z-img" src="${imgs[0]}" style="width:100%; height:350px; object-fit:contain; transition:0.3s; cursor:zoom-in;">
                    </div>
                    <div>
                        <h2 style="color:var(--primary-blue)">${p.name}</h2>
                        <h3 style="color:var(--accent-cyan); margin:10px 0;">${p.price} Ø¬.Ù… / ÙƒÙŠÙ„Ùˆ</h3>
                        <div style="display:flex; align-items:center; gap:10px; margin-top:30px;">
                            <input type="number" id="prod-qty" value="1" min="1" style="width:70px; padding:10px; border-radius:10px; border:1px solid #ddd;">
                            <button class="admin-btn" style="flex:1" onclick="addToCart('${p.id}')">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
                        </div>
                    </div>
                </div>
                <div style="display:flex; gap:10px; margin-top:20px; overflow-x:auto;">
                    ${imgs.map(i => `<img src="${i}" style="width:60px; height:60px; cursor:pointer; border-radius:8px; border:1px solid #eee;" onclick="document.getElementById('z-img').src='${i}'">`).join('')}
                </div>
                <div style="margin-top:30px;">
                    <h4>Ø£Ù†ÙˆØ§Ø¹ Ù…Ø´Ø§Ø¨Ù‡Ø© ğŸ¦</h4>
                    <div id="related-list" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:15px; margin-top:15px;"></div>
                </div>
            `;
            document.getElementById('detail-overlay').style.display = 'block';

            // Related Logic
            const related = allProducts.filter(i => i.category === p.category && i.id !== p.id).slice(0, 4);
            const relCon = document.getElementById('related-list');
            related.forEach(rp => {
                relCon.innerHTML += `<div onclick="viewProduct('${rp.id}')" style="cursor:pointer; text-align:center;"><img src="${rp.images.split(/[\n,]+/)[0]}" style="width:100%; height:100px; object-fit:cover; border-radius:8px;"><h6>${rp.name}</h6></div>`;
            });

            // Zoom
            const img = document.getElementById('z-img');
            img.parentElement.onmousemove = e => { img.style.transformOrigin = `${(e.offsetX / img.offsetWidth) * 100}% ${(e.offsetY / img.offsetHeight) * 100}%`; img.style.transform = "scale(2)"; };
            img.parentElement.onmouseleave = () => img.style.transform = "scale(1)";
        }

        // --- 5. Cart & Checkout ---
        function addToCart(id) {
            const qty = parseInt(document.getElementById('prod-qty').value);
            const p = allProducts.find(x => x.id === id);
            for (let i = 0; i < qty; i++) cart.push(p);
            updateCart(); alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³Ù„Ø©"); closeModals();
        }

        function openCheckout() {
            if (cart.length === 0) return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©");
            const con = document.getElementById('cart-list');
            const grouped = cart.reduce((acc, item) => { acc[item.name] = (acc[item.name] || 0) + 1; return acc; }, {});

            con.innerHTML = Object.keys(grouped).map(name => `
                <div class="data-item glass-panel" style="display:flex; justify-content:space-between; padding:10px; margin-bottom:5px;">
                    <span>${name} (x${grouped[name]})</span>
                    <i class="fa fa-trash" style="color:red; cursor:pointer;" onclick="removeFromCart('${name}')"></i>
                </div>
            `).join('');

            updateBillUI();
            document.getElementById('checkout-overlay').style.display = 'flex';
        }

        function updateBillUI() {
            const gov = document.getElementById('c-gov').value;
            const shipPrice = (settings.govShipping && settings.govShipping[gov]) ? parseFloat(settings.govShipping[gov]) : 0;
            const subtotal = cart.reduce((s, i) => s + i.price, 0);
            document.getElementById('total-price-box').innerHTML = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù…Ùƒ: ${subtotal} Ø¬.Ù… <br> Ø§Ù„ØªÙˆØµÙŠÙ„: ${shipPrice} Ø¬.Ù… <br> Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${subtotal + shipPrice} Ø¬.Ù…`;
        }

        document.addEventListener('change', e => { if (e.target.id === 'c-gov') updateBillUI(); });

        function finalizeOrder() {
            const name = document.getElementById('c-name').value;
            const phone = document.getElementById('c-phone').value;
            const gov = document.getElementById('c-gov').value;
            if (!name || !gov || !phone) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

            const shipPrice = parseFloat(settings.govShipping[gov]) || 0;
            const subtotal = cart.reduce((s, i) => s + i.price, 0);

            let msg = `*Ø·Ù„Ø¨ Ø³Ù…Ùƒ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø³ÙˆÙŠØ³ÙŠ*%0AØ§Ù„Ø§Ø³Ù…: ${name}%0AØ§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„: ${phone}%0AØ§Ù„Ù…Ø­Ø§ÙØ¸Ø©: ${gov}%0AØ§Ù„Ø·Ù„Ø¨Ø§Øª:%0A`;
            const grouped = cart.reduce((acc, item) => { acc[item.name] = (acc[item.name] || 0) + 1; return acc; }, {});
            Object.keys(grouped).forEach(k => msg += `- ${k} (Ø§Ù„ÙƒÙ…ÙŠØ©: ${grouped[k]})%0A`);
            msg += `%0A*Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:* ${subtotal + shipPrice} Ø¬.Ù…`;

            // Save to Firebase for Excel
            db.collection("orders").add({ customerName: name, customerPhone: phone, governorate: gov, items: msg, totalPrice: subtotal + shipPrice, timestamp: Date.now(), orderDate: new Date().toLocaleString() });

            let wa = settings.wa.replace(/\D/g, ''); if (!wa.startsWith('20')) wa = '20' + wa;
            window.open(`https://api.whatsapp.com/send?phone=${wa}&text=${msg}`, '_blank');
            cart = []; updateCart(); closeModals();
        }

        // --- 6. Admin Actions ---
        function loginAdmin() { if (prompt("Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯:") === "admin123") { sessionStorage.setItem('isAdmin', 'true'); showAdmin(); } }
        function showAdmin() { document.getElementById('store-front').style.display = 'none'; document.getElementById('admin-panel').style.display = 'block'; localStorage.setItem('viewState', 'admin'); }
        function backToStore() { document.getElementById('admin-panel').style.display = 'none'; document.getElementById('store-front').style.display = 'block'; localStorage.setItem('viewState', 'store'); }
        function logoutAdmin() { sessionStorage.removeItem('isAdmin'); location.reload(); }

        function handleProductSave() {
            const id = document.getElementById('edit-prod-id').value;
            const data = { name: document.getElementById('adm-name').value, images: document.getElementById('adm-imgs').value, price: parseFloat(document.getElementById('adm-price').value), category: document.getElementById('adm-cat').value, subcategory: document.getElementById('adm-subcat').value, visibility: 'visible' };
            const op = id ? db.collection("products").doc(id).update(data) : db.collection("products").add(data);
            op.then(() => { alert("ØªÙ… Ø§Ù„Ø­ÙØ¸"); clearForms(); });
        }

        function handleSliderSave() {
            const imgs = document.getElementById('adm-slider-input').value.split('\n').filter(i => i.trim() !== "");
            db.collection("settings").doc("slider").set({ images: imgs }).then(() => alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±"));
        }

        function exportOrdersToExcel() {
            db.collection("orders").orderBy("timestamp", "desc").get().then(snap => {
                const data = [];
                snap.forEach(doc => data.push(doc.data()));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Orders");
                XLSX.writeFile(wb, "Mahmoud_Sweissy_Sales.xlsx");
            });
        }

        // --- Helper Functions ---
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function toggleSearch() { const s = document.getElementById('search-bar'); s.style.display = (s.style.display === 'none' ? 'block' : 'none'); }
        function updateCart() { document.getElementById('cart-count').innerText = cart.length; }
        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }
        function deleteDoc(col, id) { if (confirm("Ø­Ø°ÙØŸ")) db.collection(col).doc(id).delete(); }
        function removeFromCart(name) { cart = cart.filter(i => i.name !== name); updateCart(); if (cart.length === 0) closeModals(); else openCheckout(); }
        function backToStore() { document.getElementById('admin-panel').style.display = 'none'; document.getElementById('store-front').style.display = 'block'; }

        function buildSmartSidebar() {
            const con = document.getElementById('side-categories'); con.innerHTML = '<div class="side-item" onclick="filterByCategory(\'Ø§Ù„ÙƒÙ„\')">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ ğŸŒŠ</div>';
            const catMap = {};
            allProducts.forEach(p => {
                if (p.category) {
                    if (!catMap[p.category]) catMap[p.category] = new Set();
                    if (p.subcategory) catMap[p.category].add(p.subcategory);
                }
            });
            for (let cat in catMap) {
                const subCats = Array.from(catMap[cat]);
                con.innerHTML += `<div class="side-item" onclick="handleCategoryClick('${cat}', ${subCats.length > 0}, '${cat}')"><b>${cat}</b></div>`;
                if (subCats.length > 0) {
                    const subHtml = subCats.map(s => `<div class="side-item" style="padding-right:30px; font-size:13px;" onclick="filterBySubCategory('${cat}', '${s}')">- ${s}</div>`).join('');
                    con.innerHTML += `<div id="sub-${cat}" class="sub-menu">${subHtml}</div>`;
                }
            }
        }

        function handleCategoryClick(cat, hasSub, id) {
            if (hasSub) {
                const m = document.getElementById('sub-' + id);
                m.style.maxHeight = (m.style.maxHeight === '500px' ? '0px' : '500px');
            }
            const filtered = allProducts.filter(p => p.category === cat);
            renderFilteredGrid(filtered);
        }

        function renderFilteredGrid(list) {
            const grid = document.getElementById('customer-product-grid');
            grid.innerHTML = list.map(p => `
                <div class="card glass-panel" onclick="viewProduct('${p.id}')">
                    <img src="${p.images.split(/[\n,]+/)[0]}">
                    <h4>${p.name}</h4><b style="color:var(--primary-blue)">${p.price} Ø¬.Ù…</b>
                </div>
            `).join('');
            if (list.length === 0) grid.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>";
        }

        function liveSearch() {
            const q = document.getElementById('search-input').value.toLowerCase();
            const filtered = allProducts.filter(p => p.name.toLowerCase().includes(q));
            renderFilteredGrid(filtered);
        }

        function clearForms() { document.querySelectorAll('input, textarea').forEach(i => i.value = ''); }

        window.onscroll = () => { document.getElementById('navbar').classList.toggle('scrolled', window.scrollY > 50); };
    </script>
</body>

</html>